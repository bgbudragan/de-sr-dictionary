<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dictionary (Plural Forming)</title>
  <style>
    :root{--black:#000;--text:#1a1a1a;--muted:#8a8a8a;--faint:#b5b5b5;--fainter:#d1d1d1;--sep:#f3f3f3;--border:#e3e3e3;--bg:#fff;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg);}
    .wrap{max-width:1180px;margin:0 auto;padding:24px}

    header{display:flex;align-items:center;justify-content:flex-end;padding:6px 0 10px;border-bottom:2px solid #ebebeb}
    header .menu{width:36px;height:36px;border:0;background:transparent;display:grid;place-items:center;cursor:pointer}
    .burger{width:22px;height:14px;position:relative}
    .burger::before,.burger::after,.burger span{content:"";position:absolute;left:0;right:0;height:2px;background:#000;border-radius:2px}
    .burger::before{top:0} .burger span{top:6px} .burger::after{bottom:0}

    .grid{display:grid;grid-template-columns:1fr 420px;gap:28px;padding-top:18px}

    .searchRow{display:flex;align-items:flex-end;gap:14px}
    .inputWrap{flex:1;min-width:220px;position:relative;padding-bottom:10px}
    input[type="text"]{width:100%;border:0;outline:none;font-size:22px;padding:0;background:transparent;color:#000}
    input::placeholder{color:#bdbdbd}
    .underline{position:absolute;left:0;right:0;bottom:0;height:4px;background:#000;border-radius:2px}

    .dir{display:flex;align-items:center;gap:8px;padding-bottom:6px;user-select:none}
    .dir button{
      border:1px solid #e6e6e6;border-bottom-width:2px;
      background:#fff;color:#666;border-radius:999px;
      padding:6px 10px;font-size:12px;cursor:pointer;
    }
    .dir button[data-active="true"]{color:#111;border-color:#dcdcdc;background:#fafafa}

    .suggestList{margin:14px 0 0 0;padding:0;list-style:none}
    .suggestItem{display:flex;align-items:baseline;justify-content:space-between;gap:16px;padding:12px 0;border-top:2px solid var(--sep);cursor:pointer}
    .suggestItem:first-child{border-top:0}
    .suggestItem .hw{font-size:18px;color:var(--faint)}
    .suggestItem .tr{font-size:18px;color:var(--fainter);text-align:right;min-width:120px}
    .suggestItem[data-active="true"]{background:#fafafa;border-radius:10px;padding-left:10px;padding-right:10px}
    .suggestItem[data-active="true"] .hw{color:#666}
    .suggestItem[data-active="true"] .tr{color:#7a7a7a}

    .detail{border:2px solid var(--border);border-radius:16px;padding:18px;height:calc(100vh - 120px);max-height:720px;overflow:auto;position:sticky;top:20px;background:#fff}

    .wordRow{display:flex;align-items:baseline;gap:12px;flex-wrap:wrap}
    .word{font-size:40px;font-weight:800;margin:4px 0 6px;color:#000;letter-spacing:.2px}

    .plTag{
      font-size:14px;
      color:var(--muted);
      border:1px solid #eee;
      border-bottom-width:2px;
      background:#fff;
      border-radius:999px;
      padding:4px 10px;
      font-weight:700;
      margin-top:6px;
    }

    .meta{color:var(--faint);font-size:14px;margin-bottom:10px;line-height:1.35}
    .wordUnderline{height:4px;width:160px;background:#000;border-radius:2px;margin:10px 0 16px}
    .gloss{font-size:22px;line-height:1.35;color:var(--text);margin:0}

    /* Colored German articles (RIGHT panel only) */
    .art{font-weight:700}
    .art.der{color:#1f6feb;}  /* blue */
    .art.die{color:#d1242f;}  /* red */
    .art.das{color:#2da44e;}  /* green */
    .meta .art{font-weight:700}

    .keys{margin-top:10px;color:var(--fainter);font-size:12px;user-select:none}
    kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:12px;border:1px solid #e6e6e6;border-bottom-width:2px;border-radius:6px;padding:2px 6px;background:#fff;color:#777}

    .err{margin-top:10px;color:#b00020;font-size:12px;display:none}
    .loading{margin-top:10px;color:#c9c9c9;font-size:12px;display:none}

    @media (max-width:920px){
      .grid{grid-template-columns:1fr}
      .detail{position:relative;top:auto;height:auto;max-height:none}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <button class="menu" aria-label="Menu" title="Menu"><div class="burger"><span></span></div></button>
    </header>

    <div class="grid">
      <section>
        <div class="searchRow">
          <div class="inputWrap">
            <input id="q" type="text" autocomplete="off" spellcheck="false" placeholder="Search" />
            <div class="underline"></div>
          </div>

          <div class="dir" aria-label="Direction">
            <button id="btnSRDE" data-active="true" title="Serbian → German">SR→DE</button>
            <button id="btnDESR" data-active="false" title="German → Serbian">DE→SR</button>
          </div>
        </div>

        <ul id="list" class="suggestList"></ul>
        <div class="loading" id="loading">Loading…</div>
        <div class="err" id="err"></div>
        <div class="keys"><kbd>↑</kbd> <kbd>↓</kbd> <kbd>Enter</kbd> <kbd>Esc</kbd></div>
      </section>

      <aside class="detail" id="detail"></aside>
    </div>
  </div>

<script>
  const q = document.getElementById("q");
  const list = document.getElementById("list");
  const detail = document.getElementById("detail");
  const btnSRDE = document.getElementById("btnSRDE");
  const btnDESR = document.getElementById("btnDESR");
  const errBox = document.getElementById("err");
  const loading = document.getElementById("loading");

  let dir = "SR_DE";
  let results = [];
  let active = 0;

  function setDir(next){
    dir = next;
    btnSRDE.dataset.active = (dir==="SR_DE") ? "true" : "false";
    btnDESR.dataset.active = (dir==="DE_SR") ? "true" : "false";
    search();
    q.focus();
  }

  btnSRDE.addEventListener("click", ()=> setDir("SR_DE"));
  btnDESR.addEventListener("click", ()=> setDir("DE_SR"));

  function escapeHtml(s){
    return (s ?? "").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;")
      .replaceAll(">","&gt;").replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // Normalize main_gloss:
  // "(die) Rede" -> "die Rede"
  // "(Der) ..."  -> "der ..."
  function normalizeGloss(s){
    const t = (s ?? "").toString().trim();
    return t.replace(/^\((der|die|das)\)\s+/i, (_, art) => art.toLowerCase() + " ");
  }

  // RIGHT PANEL: color only the German article (der/die/das) if present at the start
  function splitArticleFromGloss(gloss){
    const g = normalizeGloss(gloss || "");
    const m = g.match(/^(der|die|das)\s+(.+)$/i);
    if(!m) return { article: null, rest: g };
    return { article: m[1].toLowerCase(), rest: m[2] };
  }

  function renderGlossWithColoredArticle(gloss){
    const { article, rest } = splitArticleFromGloss(gloss);
    if(!article) return `<span>${escapeHtml(normalizeGloss(gloss || "—"))}</span>`;
    return `<span class="art ${article}">${escapeHtml(article)}</span> ${escapeHtml(rest)}`;
  }

  // MIX: UI micro on EN, meta descriptors on SR
  const POS_MAP_SR = {
    "noun": "imenica",
    "verb": "glagol",
    "adj":  "pridev",
    "adv":  "prilog",
    "prep": "predlog",
    "pron": "zamenica",
    "num":  "broj",
    "conj": "veznik",
    "intj": "uzvik",
    "part": "rečca",
    "prefix": "prefiks"
  };

  function toSrPos(pos){
    const p = (pos || "").toString().trim().toLowerCase();
    return POS_MAP_SR[p] || (pos || "");
  }

  function firstTopic(topics){
    if(!topics) return "";
    if(Array.isArray(topics) && topics.length) return topics[0];
    return String(topics);
  }

  // META (RIGHT): color der/die/das when present in gender
  function renderMetaHtml(item){
    const posSr = toSrPos(item.pos);
    const gender = (item.gender || "").toString().trim().toLowerCase();

    const genderHtml = (gender === "der" || gender === "die" || gender === "das")
      ? ` • <span class="art ${gender}">${escapeHtml(gender)}</span>`
      : (gender ? ` • ${escapeHtml(gender)}` : "");

    const lvl = item.level ? ` | ${escapeHtml(item.level)}` : "";
    const t0 = firstTopic(item.topics);
    const t = t0 ? ` | tema: ${escapeHtml(t0)}` : "";

    return `${escapeHtml(posSr)}${genderHtml}${lvl}${t}`;
  }

  // --- Plural helpers (DE→SR only) ---
  function applyUmlautHeuristic(stem){
    const variants = [];

    if(stem.includes("au")) variants.push(stem.replace("au","äu"));
    if(stem.includes("Au")) variants.push(stem.replace("Au","Äu"));

    if(stem.includes("a")) variants.push(stem.replace("a","ä"));
    if(stem.includes("A")) variants.push(stem.replace("A","Ä"));

    if(stem.includes("o")) variants.push(stem.replace("o","ö"));
    if(stem.includes("O")) variants.push(stem.replace("O","Ö"));

    if(stem.includes("u")) variants.push(stem.replace("u","ü"));
    if(stem.includes("U")) variants.push(stem.replace("U","Ü"));

    for(const v of variants){
      if(v && v !== stem) return v;
    }
    return stem;
  }

  // Supports:
  //  - "-s", "-er", "er", "s"
  //  - "¨-er", "¨er"
  //  - "-ü-er", "ü-er" (means: umlaut + suffix)
  function parsePluralField(pluralField){
    const raw = (pluralField ?? "").toString().trim();
    if(!raw) return { raw: "", suffix: "", umlaut: false };

    let umlaut = false;
    let s = raw;

    // normalize leading markers
    if(s.startsWith("¨-")){
      umlaut = true;
      s = s.slice(2);
    }else if(s.startsWith("¨")){
      umlaut = true;
      s = s.slice(1);
      if(s.startsWith("-")) s = s.slice(1);
    }else if(s.startsWith("-")){
      s = s.slice(1);
    }

    s = s.trim();

    // handle formats like "ü-er", "ä-e", "ö-en" etc.
    const m = s.match(/^([äöüÄÖÜ])\-?(e|er|en|n|s)$/);
    if(m){
      umlaut = true;
      s = m[2]; // keep only the real suffix
    }

    return { raw, suffix: s, umlaut };
  }

  function isLikelySuffix(pluralField){
    const { suffix } = parsePluralField(pluralField);
    if(suffix === "") return true;
    return ["e","er","en","n","s"].includes(suffix);
  }

  function buildPluralForm(headword, pluralField){
    const hw = (headword ?? "").toString().trim();
    const { raw, suffix, umlaut } = parsePluralField(pluralField);
    if(!hw || raw === "") return "";

    // If not a typical suffix, assume it's already a full plural form
    if(!isLikelySuffix(pluralField)) return raw;

    let base = hw;

    // apply umlaut if flagged OR for suffixes where it often occurs
    if(umlaut || ["e","er","en","n"].includes(suffix)){
      base = applyUmlautHeuristic(base);
    }

    return base + suffix;
  }

  // Shows: Pl: <FULL_PLURAL> (and, if suffix-mode, shows (-suffix) or (¨-suffix))
  function renderPluralTag(item){
    if(dir !== "DE_SR") return "";

    const pos = (item?.pos ?? "").toString().trim().toLowerCase();
    const plFieldRaw = (item?.plural ?? "").toString().trim();
    if(pos !== "noun" || !plFieldRaw) return "";

    const fullPlural = buildPluralForm(item.headword, plFieldRaw);
    if(!fullPlural) return "";

    const { suffix, umlaut } = parsePluralField(plFieldRaw);
    const suffixMode = isLikelySuffix(plFieldRaw) && suffix;

    const suffixInfo = suffixMode
      ? ` <span style="opacity:.65">(${escapeHtml(umlaut ? "¨-" + suffix : "-" + suffix)})</span>`
      : "";

    return `<span class="plTag">Pl: ${escapeHtml(fullPlural)}${suffixInfo}</span>`;
  }

  function renderDetail(item){
    if(!item){
      detail.innerHTML = `
        <div class="word">—</div>
        <div class="meta">Kucaj za pretragu (${dir==="SR_DE" ? "SR→DE" : "DE→SR"})</div>
        <div class="wordUnderline"></div>
        <p class="gloss">main_gloss će se prikazati ovde.</p>`;
      return;
    }

    detail.innerHTML = `
      <div class="wordRow">
        <div class="word">${escapeHtml(item.headword)}</div>
        ${renderPluralTag(item)}
      </div>
      <div class="meta">${renderMetaHtml(item)}</div>
      <div class="wordUnderline"></div>
      <p class="gloss">${renderGlossWithColoredArticle(item.main_gloss || "—")}</p>
    `;
  }

  function renderList(){
    list.innerHTML = "";
    results.forEach((item, idx) => {
      const li = document.createElement("li");
      li.className = "suggestItem";
      li.dataset.active = (idx===active) ? "true" : "false";
      li.innerHTML = `
        <div class="hw">${escapeHtml(item.headword)}</div>
        <div class="tr">${escapeHtml(normalizeGloss(item.main_gloss || ""))}</div>
      `;
      li.addEventListener("mouseenter", ()=>{ active=idx; renderList(); renderDetail(results[active]); });
      li.addEventListener("click", ()=>{ active=idx; renderList(); renderDetail(results[active]); });
      list.appendChild(li);
    });
    renderDetail(results[active]);
  }

  async function fetchJson(url){
    const r = await fetch(url, { headers: { "Accept": "application/json" }});
    if(!r.ok){
      const t = await r.text().catch(()=> "");
      throw new Error(`HTTP ${r.status} ${r.statusText}${t ? " — " + t : ""}`);
    }
    return r.json();
  }

  async function search(){
    const term = q.value.trim();
    errBox.style.display = "none";
    loading.style.display = "block";

    try{
      const params = new URLSearchParams({ direction: dir, q: term, limit: "20" });
      const data = await fetchJson(`/api/dict/search?${params.toString()}`);

      results = Array.isArray(data) ? data : (data?.rows || []);
      active = 0;
      renderList();
    }catch(e){
      results = [];
      active = 0;
      list.innerHTML = "";
      renderDetail(null);
      errBox.textContent = String(e.message || e);
      errBox.style.display = "block";
    }finally{
      loading.style.display = "none";
    }
  }

  q.addEventListener("input", ()=>{
    clearTimeout(window.__t);
    window.__t = setTimeout(search, 120);
  });

  q.addEventListener("keydown", (e)=>{
    if(e.key==="ArrowDown"){ e.preventDefault(); if(results.length){ active=Math.min(active+1, results.length-1); renderList(); } }
    else if(e.key==="ArrowUp"){ e.preventDefault(); if(results.length){ active=Math.max(active-1, 0); renderList(); } }
    else if(e.key==="Enter"){ e.preventDefault(); renderDetail(results[active]); }
    else if(e.key==="Escape"){ e.preventDefault(); q.value=""; q.focus(); search(); }
  });

  // init
  renderDetail(null);
  q.focus();
  search();
</script>
</body>
</html>
