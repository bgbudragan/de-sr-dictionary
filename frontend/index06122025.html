<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="UTF-8" />
  <title>Mali DE–SR rečnik</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;        /* svetlo siva pozadina stranice */
      color: #111;                 /* skoro crna */
    }

    .app {
      max-width: 1100px;
      margin: 10px auto;
      border: 1px solid #ddd;
      background: #ffffff;         /* bela pozadina aplikacije */
      display: flex;
      flex-direction: column;
      height: 90vh;
    }

    header {
      background: #000000;         /* crni header */
      color: #ffffff;
      padding: 6px 10px 4px 10px;
      font-size: 14px;
      border-bottom: 1px solid #222;
    }

    .header-title {
      display: block;
      margin-bottom: 4px;
    }

    .logo {
      display: block;
      width: 100%;
      height: auto;
      max-height: 120px;
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
      flex-wrap: wrap;
      padding: 0;
    }

    /* podrazumevano: opcija ISKLJUČENA → crno dugme, belo slovo */
    .toolbar button {
      padding: 4px 8px;
      border: 1px solid #666;
      background: #000000;
      cursor: pointer;
      font-size: 12px;
      color: #ffffff;
    }

    .toolbar button:hover {
      background: #222222;
    }

    /* kada je OPCIJA UKLJUČENA/SELEKTOVANA → belo dugme, crno slovo */
    .toolbar button.active {
      background: #ffffff;
      color: #000000;
      font-weight: bold;
      border-color: #000000;
    }

    .toolbar label {
      font-size: 12px;
      color: #f0f0f0;
    }

    /* crno/beli checkbox umesto plavog */
    .toolbar input[type="checkbox"] {
      width: 14px;
      height: 14px;
      cursor: pointer;
      accent-color: #ffffff;
    }

    #searchInput {
      margin-left: auto;
      padding: 4px;
      font-size: 13px;
      min-width: 220px;
      border: 1px solid #ccc;
      border-radius: 2px;
    }

    .main {
      flex: 1;
      display: grid;
      grid-template-columns: 220px 1fr 220px;
      gap: 4px;
      padding: 4px;
      background: #f5f5f5;
      grid-auto-rows: minmax(0, 1fr);  /* visina reda vezana za app */
      min-height: 0;                   /* da se ne rasteže preko ekrana */
    }

    .panel {
      background: #ffffff;
      border: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-height: 0;                   /* panel sme da se „stisne“ */
    }

    .panel h3 {
      background: #f0f0f0;
      padding: 4px 6px;
      font-size: 12px;
      border-bottom: 1px solid #ddd;
      color: #111;
    }

    .panel-content {
      flex: 1;
      overflow: auto;
      padding: 4px;
      font-size: 13px;
      position: relative;   /* zbog tooltipa za imenice */
      min-height: 0;        /* sadržaj ne širi panel */
    }

    .list {
      list-style: none;
      font-size: 13px;
    }

    .list li {
      padding: 2px 4px;
      cursor: pointer;
    }

    .list li:hover {
      background: #eeeeee;
    }

    .list li.selected {
      background: #000000;
      color: #ffffff;
    }

    /* deo reči koji se poklapa sa pretragom u listama A/B */
    .list .match {
      font-weight: bold;
    }

    /* jedan prikaz reči */
    .entry-container {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 10px;
    }

    .entry {
      flex: 1;
      background: #ffffff;
      border: 1px solid #eee;
      padding: 6px;
    }

    .entry h2 {
      color: #000000;
      font-size: 20px;
      margin-bottom: 3px;
    }

    .entry .meta {
      font-style: italic;
      font-size: 13px;
      margin-bottom: 4px;
      color: #444;
    }

    .entry ol {
      padding-left: 18px;
      margin-top: 4px;
    }

    .entry li {
      margin-bottom: 4px;
    }

    .entry .label {
      font-style: italic;
    }

    .entry .example {
      display: block;
      margin-left: 4px;
    }

    .entry .example strong {
      font-weight: bold;
    }

    /* mali tooltip preko title=... za skraćenice (adj., i. gl. itd.) */
    .abbr {
      border-bottom: 1px dotted #888;
      cursor: help;
    }

    /* klikabilne reči iz sadržaja (headword linkovi) */
    .hw-link {
      text-decoration: underline dotted;
      cursor: pointer;
    }

    /* slika reči (ako postoji) */
    .entry-image img {
      max-width: 160px;
      height: auto;
      border: 1px solid #ddd;
    }

    .history-item {
      padding: 2px 4px;
      cursor: pointer;
    }

    .history-item:hover {
      background: #eeeeee;
    }

    .footer-note {
      padding: 2px 6px;
      font-size: 11px;
      background: #fafafa;
      border-top: 1px solid #ddd;
      color: #555;
    }

    /* highlight u panelu Značenje reči kod pretrage "Ceo tekst" */
    .fulltext-match {
      background: #b3d7ff;  /* svetloplava, kao selekcija */
      padding: 0 1px;
    }

    /* tooltip za jedninu/množinu imenica */
    .noun-overlay {
      position: absolute;
      display: none;
      background: #ffffe0;
      border: 1px solid #aaa;
      padding: 2px 4px;
      font-size: 11px;
      white-space: nowrap;
      z-index: 20;
      box-shadow: 0 1px 3px rgba(0,0,0,0.25);
    }

    .noun-overlay .art-der {
      color: #0066cc;   /* der – plavo */
      font-weight: bold;
    }

    .noun-overlay .art-die {
      color: #cc0000;   /* die – crveno */
      font-weight: bold;
    }

    .noun-overlay .art-das {
      color: #008800;   /* das – zeleno */
      font-weight: bold;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="header-title">
      <!-- stavi logo.png u isti folder kao index.html -->
      <img src="logo.png" class="logo" alt="Logo rečnika" />
    </div>

    <div class="toolbar">
      <button id="btnNS" class="active">DE → SR</button>
      <button id="btnSN">SR → DE</button>

      <button id="btnHeadword" class="active">Reč</button>
      <button id="btnFulltext">Ceo tekst</button>

      <button id="btnWithin">Unutar reči</button>

      <label>
        <input type="checkbox" id="doubleViewToggle" />
        Prikaz dve reči
      </label>

      <input
        id="searchInput"
        type="text"
        placeholder="unesite reč... / Wort eingeben..."
      />
    </div>
  </header>

  <div class="main">
    <!-- Levo: A + B -->
    <div class="panel">
      <h3>Reč / Wort</h3>
      <div class="panel-content" id="listAContainer"></div>
      <h3>Unutar reči / Im Wort</h3>
      <div class="panel-content" id="listBContainer"></div>
    </div>

    <!-- Sredina: panel C -->
    <div class="panel">
      <h3>Značenje reči / Wortbedeutung</h3>
      <div class="panel-content" id="contentPanel">
        <p>Učitavanje podataka sa servera...</p>
      </div>
      <div class="footer-note">
        Mod: <span id="modeInfo">DE→SR, pretraga po reči / Suche nach Wort</span>
      </div>
    </div>

    <!-- Desno: istorija D -->
    <div class="panel">
      <h3>Istorijat pretrage / Suchhistorie</h3>
      <div class="panel-content" id="historyPanel"></div>
    </div>
  </div>
</div>

<script>
  // --- PODACI: sada stižu iz backend-a --------------------------

  let entriesDESR = [];
  const entriesSRDE = []; // za kasnije, kad ubacimo SR→DE

  // --- Stanje --------------------------------------------------

  let currentDirection = "DE_SR";
  let searchMode = "headword"; // 'headword' ili 'fulltext'
  let searchWithinWords = false;
  let doubleView = false;

  let currentEntries = [];
  let selectedIds = [];
  let history = [];

  const listAContainer = document.getElementById("listAContainer");
  const listBContainer = document.getElementById("listBContainer");
  const contentPanel = document.getElementById("contentPanel");
  const historyPanel = document.getElementById("historyPanel");
  const searchInput = document.getElementById("searchInput");
  const modeInfo = document.getElementById("modeInfo");

  let nounOverlay = null;

  function ensureNounOverlay() {
    if (!nounOverlay) {
      nounOverlay = document.createElement("div");
      nounOverlay.id = "nounOverlay";
      nounOverlay.className = "noun-overlay";
    }
    if (!contentPanel.contains(nounOverlay)) {
      contentPanel.appendChild(nounOverlay);
    }
    nounOverlay.style.display = "none";
  }

  // --- SKRAĆENICE: mapa za tooltipe ------------------------------

  const ABBR_MAP = {
    // gramaticke
    "adj.": "pridev, Adjektiv",
    "adv.": "prilog, Adverb",
    "akuz.": "akuzativ, Akkusativ",
    "Akk.": "akuzativ, Akkusativ",
    "aug.": "augmentativ, Augmentativ",
    "bezl.": "bezlično, unpersönlich",
    "bezl. gl.": "bezlični glagol, unpersönliches Verb",
    "br.": "broj, Numerale",
    "čl.": "član, Artikel",
    "dat.": "dativ, Dativ",
    "Dat.": "dativ, Dativ",
    "dem.": "deminutiv, Diminutiv",
    "f.": "ženski rod, Femininum",
    "fon.": "fonetika, Fonetik",
    "gen.": "genitiv, Genitiv",
    "Gen.": "genitiv, Genitiv",
    "imperat.": "zapovedni način, Imperativ",
    "inf.": "infinitiv, Infinitiv",
    "i. gl.": "neprelazni glagol, intransitives Verb",
    "i.gl.": "neprelazni glagol, intransitives Verb",
    "ins.": "instrumental, 6. padež (im Serbischen)",
    "Ins.": "instrumental, der 6. Fall (im Serbischen)",
    "kaus.": "kauzalno/za uzrok, kausal",
    "komp.": "komparativ, Komparativ",
    "kond.": "pogodbено, kondicional",
    "konj.": "konjunktiv, Konjunktiv",
    "l.": "lice, Person",
    "lic.": "lice, Person",
    "lok.": "lokalno/lokalitet, lokal",
    "Lok.": "lokativ, der 7. Fall (im Serbischen)",
    "m.": "muški rod, Maskulinum",
    "mod.": "modalno, modal",
    "mod. gl.": "modalni glagol, Modalverb",
    "n.": "srednji rod, Neutrum",
    "nagl. pref.": "naglašeni prefiks(oid), betontes Präfix(oid)",
    "neg.": "negacija, Negation",
    "nenagl. pref.": "nenaglašeni prefiks(oid), unbetontes Präfix(oid)",
    "nepr. gl.": "nepravilan glagol, unregelmäßiges Verb",

    "nepr.t gl.": "nepravilan tranzitivni glagol, unregelmäßiges transitives Verb",
    "nepr.t g/.": "nepravilan tranzitivni glagol, unregelmäßiges transitives Verb",
    "nepr.t.gl.": "nepravilan tranzitivni glagol, unregelmäßiges transitives Verb",

    "nom.": "nominativ, Nominativ",
    "Nom.": "nominativ, Nominativ",
    "obj.": "objekat, Objekt",
    "odr. čl.": "određeni član, der bestimmte Artikel",
    "partit.": "partitiv, Partitiv",
    "partik.": "partikula, Partikel",
    "pl.": "množina, Plural",
    "Pl.": "množina, Plural",
    "pom. gl.": "pomoćni glagol, Hilfsverb",
    "p. perf.": "particip perfekta, Partizip Perfekt",
    "p. prez.": "particip prezenta, Partizip Präsens",
    "pref.": "prefiks(oid), Präfix(oid)",
    "prep.": "predlog, Präposition",
    "prez.": "prezent, Präsens",
    "pret.": "preterit, Präteritum",
    "r. gl.": "refleksivni glagol, reflexives Verb",
    "r.gl.": "refleksivni glagol, reflexives Verb",
    "sg.": "jednina, Singular",
    "Sg.": "jednina, Singular",
    "suf.": "sufiks(oid), Suffix(oid)",
    "superl.": "superlativ, Superlativ",
    "temp.": "temporalno vreme, Tempus",
    "tr. gl.": "prelazni glagol, transitives Verb",
    "t. gl.": "prelazni glagol, transitives Verb",
    "t.gl.": "prelazni glagol, transitives Verb",
    "uzv.": "uzvik, Interjektion",
    "vezn.": "veznik, Konjunktion",
    "Vok.": "vokativ, der 5. Fall (im Serbischen)",
    "e-e": "jedna/jednu, eine",
    "e-m": "jednom, einem",
    "e-n": "jednog, einen",
    "e-r": "jedne/jednoj, einer",
    "e-s": "(od) jednog, eines",
    "etw.": "nešto, etwas",
    "jd.": "neko, jemand",
    "jdm.": "nekom, jemandem",
    "jdn.": "nekog, jemanden",
    "jds.": "nekog, jemandes",

    // ostale / tematske skraćenice
    "adm.": "administracija, Administration",
    "lingv.": "lingvistika, Linguistik",
    "anat.": "anatomija, Anatomie",
    "lit.": "literatura, Literatur",
    "AOP": "automatska obrada podataka, (EDV) elektronische Datenverarbeitung",
    "lov.": "lovstvo, Jagdwesen",
    "mat.": "matematika, Mathematik",
    "arh.": "arhaično, archaisch",
    "med.": "medicina, Medizin",
    "arheol.": "arheologija, Archeologie",
    "meh.": "mehanika, Mechanik",
    "arhit.": "arhitektura, Architektur",
    "met.": "meteorologija, Meteorologie",
    "astrol.": "astrologija, Astrologie",
    "metal.": "metalurgija, Metallurgie",
    "astron.": "astronomija, Astronomie",
    "mit.": "mitologija, Mythologie",
    "austr.": "austrijski, österreichisch",
    "muz.": "muzika, Musik",
    "napr.": "na primer, z.B., zum Beispiel",
    "npr.": "na primer, z. B.",
    "aut.": "automobilizam, Automobilismus",
    "nov.": "novinarstvo, Journalistik",
    "av.": "avijacija, Flugwesen",
    "opt.": "optika, Optik",
    "bank.": "bankarstvo, Bankwesen",
    "orn.": "ornitologija, Ornithologie",
    "bibl.": "biblija, Bibel",
    "osig.": "osiguranje, Versicherung",
    "biol.": "biologija, Biologie",
    "pej.": "pežorativno/pogrdno, pejorativ",
    "bol.": "bolnica, Krankenhaus",
    "poet.": "pesnički, poetisch",
    "bot.": "botanika, Botanik",
    "pol.": "politika, Politik",
    "cirk.": "cirkus, Zirkus",
    "polj.": "poljoprivreda, Agrikultur",
    "dipl.": "diplomatija, Diplomatie",
    "pom.": "pomorstvo, Nautik",
    "dosl.": "doslovno, buchstäblich",
    "posl.": "poslovica, Sprichwort",
    "ekol.": "ekologija, Ökologie",
    "poz.": "pozorište, Theater",
    "ekon.": "ekonomija, Ökonomie",
    "prav.": "pravo, Jura",
    "elektr.": "elektrika, Elektrik",
    "priv.": "privreda, Wirtschaft",
    "elektron.": "elektronika, Elektronik",
    "psih.": "psihologija, Psychologie",
    "farm.": "farmacija, Pharmazie",
    "rač.": "računarsto, Rechnungswesen",
    "fig.": "figurativno/preneseno, figurativ",
    "rel.": "religija, Religion",
    "filoz.": "filozofija, Philosophie",
    "finan.": "finasije, Finanzwesen",
    "rud.": "rudarstvo, Bergwerk",
    "fiz.": "fizika, Physik",
    "šalj.": "šaljivo, scherzhaft",
    "fiziol.": "fiziologija, Physiologie",
    "skr.": "skraćenica, Abkürzung",
    "form.": "formalno, formell",
    "slik.": "slikarstvo, Malerei",
    "fot.": "fotografija, Fotografie",
    "soc.": "sociologija, Soziologie",
    "geod.": "geodezija, Geodäsie",
    "štamp.": "štamparstvo, Druckerei",
    "geogr.": "geografija, Geografie",
    "švajc.": "švajcarski, schweizerisch",
    "geol.": "geologija, Geologie",
    "tehn.": "tehnika, Technik",
    "geom.": "geometrija, Geometrie",
    "telekom.": "telekomunikacije, Telekommunikation",
    "građ.": "građevinarstvo, Bauwesen",
    "term.": "termika, Termik",
    "gram.": "gramatika, Grammatik",
    "trg.": "trgovina, Handel",
    "hem.": "hemija, Chemie",
    "TV": "televizija, Fernsehen",
    "hot.": "hotelijerstvo, Hotelwesen",
    "umet.": "umetnost, Kunst",
    "iron.": "ironično, ironisch",
    "univ.": "univerzitet, Universität",
    "ist.": "istorija, Geschichte",
    "vet.": "veterina, Veterinärmedizin",
    "kat.": "katolički, katholisch",
    "voj.": "vojska, Militär",
    "kol.": "kolokvijalno, umgangssprachlich",
    "vulg.": "vulgarno, vulgär",
    "kompj.": "računarstvo, Computerwesen",
    "žel.": "železnica, Eisenbahn",
    "kosm.": "kosmonautika, Kosmonautik",
    "kul.": "kulinarstvo, Kochkunst",
    "zool.": "zoologija, Zoologie"
  };

  function escapeAbbrRegex(str) {
    return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
  }

  const ABBR_KEYS = Object.keys(ABBR_MAP).sort((a, b) => b.length - a.length);
  const ABBR_REGEX = new RegExp(ABBR_KEYS.map(escapeAbbrRegex).join("|"), "g");

  function applyAbbreviationTooltips() {
    if (!contentPanel) return;

    const walker = document.createTreeWalker(
      contentPanel,
      NodeFilter.SHOW_TEXT,
      {
        acceptNode(node) {
          if (!node.nodeValue || !node.nodeValue.trim()) {
            return NodeFilter.FILTER_REJECT;
          }
          // ne diraj već postojeće .abbr i nounOverlay
          let p = node.parentNode;
          while (p) {
            if (p.classList && p.classList.contains("abbr")) {
              return NodeFilter.FILTER_REJECT;
            }
            if (p.id === "nounOverlay") {
              return NodeFilter.FILTER_REJECT;
            }
            p = p.parentNode;
          }
          return NodeFilter.FILTER_ACCEPT;
        }
      }
    );

    const textNodes = [];
    while (walker.nextNode()) {
      textNodes.push(walker.currentNode);
    }

    textNodes.forEach(node => {
      const text = node.nodeValue;
      ABBR_REGEX.lastIndex = 0;
      let match;
      let lastIndex = 0;
      const frag = document.createDocumentFragment();
      let changed = false;

      while ((match = ABBR_REGEX.exec(text)) !== null) {
        const abbr = match[0];
        const expl = ABBR_MAP[abbr];
        if (!expl) continue;

        if (match.index > lastIndex) {
          frag.appendChild(document.createTextNode(text.slice(lastIndex, match.index)));
        }

        const span = document.createElement("span");
        span.className = "abbr";
        span.textContent = abbr;
        span.title = expl;
        frag.appendChild(span);

        lastIndex = match.index + abbr.length;
        changed = true;
      }

      if (!changed) return;

      if (lastIndex < text.length) {
        frag.appendChild(document.createTextNode(text.slice(lastIndex)));
      }

      node.parentNode.replaceChild(frag, node);
    });

    // DODATNO: za sve već postojeće .abbr spanove (npr. koje backend šalje),
    // ako nemaju title, pokušaj da ga popuniš iz ABBR_MAP.
    const abbrSpans = contentPanel.querySelectorAll("span.abbr");
    abbrSpans.forEach(span => {
      if (!span.title) {
        const key = span.textContent.trim();
        if (ABBR_MAP[key]) {
          span.title = ABBR_MAP[key];
        }
      }
    });
  }

  // --- Učitavanje podataka sa backend-a ------------------------

  async function loadEntriesFromAPI() {
    try {
      const response = await fetch("http://localhost:4000/api/entries");
      const data = await response.json();
      entriesDESR = data;
      currentEntries = entriesDESR;

      contentPanel.innerHTML =
        "<p>Unesi „ban“ u polje za pretragu ili klikni na neku reč iz liste A/B.</p>";

      filterAndRender();
    } catch (err) {
      console.error("Greška pri učitavanju podataka:", err);
      contentPanel.innerHTML =
        "<p>Ne mogu da učitam podatke iz API-ja. Proveri da li backend radi na portu 4000.</p>";
    }
  }

  // --- Promena smera --------------------------------------------------

  function setDirection(dir) {
    currentDirection = dir;
    if (dir === "DE_SR") {
      currentEntries = entriesDESR;
      document.getElementById("btnNS").classList.add("active");
      document.getElementById("btnSN").classList.remove("active");
    } else {
      currentEntries = entriesSRDE;
      document.getElementById("btnNS").classList.remove("active");
      document.getElementById("btnSN").classList.add("active");
      if (entriesSRDE.length === 0) {
        contentPanel.innerHTML =
          "<p>SR→DE još nema unetih podataka. Koristi DE→SR za ovu simulaciju.</p>";
      }
    }
    updateModeInfo();
    filterAndRender();
  }

  // --- Mod pretrage ---------------------------------------------------

  function setSearchMode(mode) {
    searchMode = mode;
    if (mode === "headword") {
      document.getElementById("btnHeadword").classList.add("active");
      document.getElementById("btnFulltext").classList.remove("active");
    } else {
      document.getElementById("btnHeadword").classList.remove("active");
      document.getElementById("btnFulltext").classList.add("active");
    }
    updateModeInfo();
    filterAndRender();
  }

  function toggleWithinWords() {
    searchWithinWords = !searchWithinWords;
    const btn = document.getElementById("btnWithin");
    btn.classList.toggle("active", searchWithinWords);
    filterAndRender();
  }

  function updateModeInfo() {
    const dirText = currentDirection === "DE_SR" ? "DE→SR" : "SR→DE";
    const modeText =
      searchMode === "headword"
        ? "pretraga po reči / Suche nach Wort"
        : "pretraga po celom tekstu / Suche im ganzen Text";
    modeInfo.textContent = dirText + ", " + modeText;
  }

  // --- Filtriranje i liste --------------------------------------------

  function filterAndRender() {
    if (!currentEntries || !currentEntries.length) {
      listAContainer.innerHTML = "<p><em>(nema podataka)</em></p>";
      listBContainer.innerHTML = "<p><em>(nema podataka)</em></p>";
      return;
    }

    const q = (searchInput.value || "").toLowerCase().trim();
    let listA = [];
    let listB = [];

    if (!q) {
      listA = currentEntries.slice();
    } else if (searchMode === "headword") {
      listA = currentEntries.filter(e =>
        e.headword.toLowerCase().startsWith(q)
      );
      if (searchWithinWords) {
        listB = currentEntries.filter(
          e =>
            e.headword.toLowerCase().includes(q) &&
            !e.headword.toLowerCase().startsWith(q)
        );
      }
    } else {
      // full-text
      listA = currentEntries.filter(e =>
        (e.plainText || "").toLowerCase().includes(q)
      );
      listB = [];
    }

    renderList(listAContainer, listA);
    renderList(listBContainer, listB);

    if (selectedIds.length) {
      renderContent();
    }
  }

  function renderList(container, items) {
    if (!items || !items.length) {
      container.innerHTML = "<p><em>(nema rezultata)</em></p>";
      return;
    }
    const q = (searchInput.value || "").toLowerCase().trim();
    const ul = document.createElement("ul");
    ul.className = "list";

    items.forEach(e => {
      const li = document.createElement("li");

      if (q) {
        const hw = e.headword || "";
        const lower = hw.toLowerCase();
        const idx = lower.indexOf(q);
        if (idx !== -1) {
          const before = hw.slice(0, idx);
          const match = hw.slice(idx, idx + q.length);
          const after = hw.slice(idx + q.length);
          li.innerHTML =
            before + '<span class="match">' + match + "</span>" + after;
        } else {
          li.textContent = hw;
        }
      } else {
        li.textContent = e.headword || "";
      }

      if (selectedIds.includes(e.id)) {
        li.classList.add("selected");
      }
      li.addEventListener("click", () => {
        onSelectEntry(e.id);
      });
      ul.appendChild(li);
    });
    container.innerHTML = "";
    container.appendChild(ul);
  }

  // --- Odabir reči ----------------------------------------------------

  function onSelectEntry(id) {
    const entry = currentEntries.find(e => e.id === id);
    if (!entry) return;

    if (!doubleView) {
      selectedIds = [id];
    } else {
      if (!selectedIds.includes(id)) {
        selectedIds.push(id);
        if (selectedIds.length > 2) {
          selectedIds.shift();
        }
      }
    }
    renderContent();
    addToHistory(entry.headword);
    filterAndRender(); // da osveži selekciju u listama
  }

  // pomoćna funkcija: iz teksta u sadržaju na odgovarajuću odrednicu
  function selectHeadwordFromContent(text) {
    const t = (text || "").trim();
    if (!t) return;

    const entry = currentEntries.find(e => {
      const hw = (e.headword || "").split(",")[0].trim().toLowerCase();
      return hw === t.toLowerCase();
    });

    if (entry) {
      onSelectEntry(entry.id);
    }
  }

  // --- Prikaz sadržaja reči -------------------------------------------

  function renderContent() {
    contentPanel.innerHTML = "";
    ensureNounOverlay();

    if (!selectedIds.length) {
      contentPanel.innerHTML =
        "<p>Izaberi reč iz liste A ili B da vidiš sadržaj.</p>";
      return;
    }

    selectedIds.forEach((id, index) => {
      const e = currentEntries.find(x => x.id === id);
      if (!e) return;

      if (index > 0) {
        const hr = document.createElement("hr");
        contentPanel.appendChild(hr);
      }

      const wrapper = document.createElement("div");
      wrapper.className = "entry-container";
      wrapper.innerHTML = e.contentHtml;

      if (e.image) {
        const imgDiv = document.createElement("div");
        imgDiv.className = "entry-image";
        const img = document.createElement("img");
        img.src = e.image;
        img.alt = e.headword;
        imgDiv.appendChild(img);
        wrapper.appendChild(imgDiv);
      }

      contentPanel.appendChild(wrapper);
    });

    // prvo ubaci tooltip-e za skraćenice
    applyAbbreviationTooltips();

    // tooltip za imenice
    processNounHeadwords();

    if (searchMode === "fulltext") {
      highlightContentMatches();
    }

    // posle svega, napravi linkove na sve reči koje su headword
    linkHeadwordsInContent();
  }

  // tooltip za imenice (jednina/množina)
  function processNounHeadwords() {
    ensureNounOverlay();
    const spans = contentPanel.querySelectorAll(".noun-headword");
    spans.forEach(span => {
      span.addEventListener("mouseenter", () => showNounOverlay(span));
      span.addEventListener("mouseleave", hideNounOverlay);
    });
  }

  function showNounOverlay(span) {
    ensureNounOverlay();

    const gender = (span.dataset.gender || "").trim(); // der/die/das
    const base = (span.dataset.base || span.textContent).trim();
    let explicitPlural = (span.dataset.plural || "").trim();
    const pluralSuffix = (span.dataset.pluralSuffix || "").trim();

    let pluralForm;
    if (explicitPlural) {
      pluralForm = explicitPlural;
    } else if (pluralSuffix && pluralSuffix !== "-") {
      const suff = pluralSuffix.replace(/^-/, "");
      pluralForm = base + suff;
    } else {
      pluralForm = "–";
    }

    const artClass =
      gender === "der" ? "art-der" : gender === "die" ? "art-die" : "art-das";

    const singularText = `${gender} ${base}`.trim();
    const pluralText = pluralForm === "–" ? "–" : `die ${pluralForm}`;

    nounOverlay.innerHTML =
      `<span class="${artClass}">${singularText}</span>, ${pluralText}`;

    // privremeno prikaži da bismo izmerili dimenzije
    nounOverlay.style.display = "block";
    nounOverlay.style.visibility = "hidden";

    const rect = span.getBoundingClientRect();
    const panelRect = contentPanel.getBoundingClientRect();

    // početno - pokušaj iznad reči
    let left = rect.left - panelRect.left;
    let top = rect.top - panelRect.top - nounOverlay.offsetHeight - 4;

    // ako bi izašao iznad panela, prebaci ispod reči
    if (top < 0) {
      top = rect.bottom - panelRect.top + 4;
    }

    // ograniči u levo/desno da tooltip ne iseče panel
    const maxLeft = panelRect.width - nounOverlay.offsetWidth - 4;
    if (left < 0) left = 0;
    if (left > maxLeft) left = maxLeft;

    nounOverlay.style.left = left + "px";
    nounOverlay.style.top = top + "px";
    nounOverlay.style.visibility = "visible";
  }

  function hideNounOverlay() {
    if (nounOverlay) {
      nounOverlay.style.display = "none";
    }
  }

  // --- Klikabilne reči u sadržaju – SVE headword-e --------------------

  function linkHeadwordsInContent() {
    if (!contentPanel || !currentEntries || !currentEntries.length) return;

    // mapa: lowercase → "glavni" oblik (pre zareza)
    const hwMap = new Map();
    const bases = [];

    currentEntries.forEach(e => {
      let hw = (e.headword || "").trim();
      if (!hw) return;
      const base = hw.split(",")[0].trim();  // samo prvi deo (pre zareza)
      if (!base) return;
      const key = base.toLowerCase();
      if (!hwMap.has(key)) {
        hwMap.set(key, base);
        bases.push(base);
      }
    });

    if (!bases.length) return;

    // da duže reči imaju prioritet (opciono)
    bases.sort((a, b) => b.length - a.length);

    function escapeRegex(s) {
      return s.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }

    const pattern = "\\b(" + bases.map(escapeRegex).join("|") + ")\\b";
    const re = new RegExp(pattern, "gi");

    const walker = document.createTreeWalker(
      contentPanel,
      NodeFilter.SHOW_TEXT,
      null
    );

    const textNodes = [];
    let node;
    while ((node = walker.nextNode())) {
      if (
        node.parentNode &&
        node.parentNode.classList &&
        node.parentNode.classList.contains("hw-link")
      ) {
        continue;
      }
      textNodes.push(node);
    }

    textNodes.forEach(textNode => {
      const text = textNode.nodeValue;
      re.lastIndex = 0;
      if (!re.test(text)) {
        return;
      }
      re.lastIndex = 0;

      const frag = document.createDocumentFragment();
      let lastIndex = 0;
      let match;

      while ((match = re.exec(text)) !== null) {
        const idx = match.index;
        const matchedWord = match[1];   // ono što se poklopilo u grupi ()

        if (idx > lastIndex) {
          frag.appendChild(
            document.createTextNode(text.slice(lastIndex, idx))
          );
        }

        const span = document.createElement("span");
        span.className = "hw-link";
        const key = matchedWord.toLowerCase();
        const canonical = hwMap.get(key) || matchedWord;
        span.dataset.hw = canonical;
        span.textContent = matchedWord;
        frag.appendChild(span);

        lastIndex = idx + matchedWord.length;
      }

      if (lastIndex < text.length) {
        frag.appendChild(
          document.createTextNode(text.slice(lastIndex))
        );
      }

      textNode.parentNode.replaceChild(frag, textNode);
    });
  }

  // delegirani klik handler za .hw-link u contentPanel-u
  contentPanel.addEventListener("click", e => {
    const span = e.target.closest(".hw-link");
    if (!span) return;
    const hw = span.dataset.hw || span.textContent;
    selectHeadwordFromContent(hw);
  });

  // --- Highlight u sadržaju kod "Ceo tekst" ---------------------------

  function highlightContentMatches() {
    const q = (searchInput.value || "").trim();
    if (!q) return;

    const qLower = q.toLowerCase();

    function walk(node) {
      if (node === nounOverlay) return;

      if (node.nodeType === Node.TEXT_NODE) {
        const text = node.nodeValue;
        const lower = text.toLowerCase();
        let idx = lower.indexOf(qLower);
        if (idx === -1) return;

        const frag = document.createDocumentFragment();
        let cur = 0;

        while (idx !== -1) {
          if (idx > cur) {
            frag.appendChild(document.createTextNode(text.slice(cur, idx)));
          }
          const span = document.createElement("span");
          span.className = "fulltext-match";
          span.textContent = text.slice(idx, idx + q.length);
          frag.appendChild(span);
          cur = idx + q.length;
          idx = lower.indexOf(qLower, cur);
        }

        if (cur < text.length) {
          frag.appendChild(document.createTextNode(text.slice(cur)));
        }

        node.parentNode.replaceChild(frag, node);
      } else if (node.nodeType === Node.ELEMENT_NODE) {
        if (node.tagName === "SCRIPT" || node.tagName === "STYLE") return;
        if (node.id === "nounOverlay") return;
        const children = Array.from(node.childNodes);
        children.forEach(walk);
      }
    }

    walk(contentPanel);
  }

  // --- Istorija -------------------------------------------------------

  function addToHistory(headword) {
    if (!headword) return;
    if (history.length && history[history.length - 1] === headword) return;
    history.push(headword);
    renderHistory();
  }

  function renderHistory() {
    if (!history.length) {
      historyPanel.innerHTML = "<p><em>Još nema istorije.</em></p>";
      return;
    }
    historyPanel.innerHTML = "";
    history
      .slice()
      .reverse()
      .forEach(hw => {
        const div = document.createElement("div");
        div.className = "history-item";
        div.textContent = hw;
        div.addEventListener("click", () => {
          const entry = currentEntries.find(e => e.headword === hw);
          if (entry) {
            onSelectEntry(entry.id);
          }
        });
        historyPanel.appendChild(div);
      });
  }

  // --- Event listener-i ----------------------------------------

  document.getElementById("btnNS").addEventListener("click", () => {
    setDirection("DE_SR");
  });

  document.getElementById("btnSN").addEventListener("click", () => {
    setDirection("SR_DE");
  });

  document.getElementById("btnHeadword").addEventListener("click", () => {
    setSearchMode("headword");
  });

  document.getElementById("btnFulltext").addEventListener("click", () => {
    setSearchMode("fulltext");
  });

  document.getElementById("btnWithin").addEventListener("click", () => {
    toggleWithinWords();
  });

  document
    .getElementById("doubleViewToggle")
    .addEventListener("change", e => {
      doubleView = e.target.checked;
      if (!doubleView && selectedIds.length > 1) {
        selectedIds = selectedIds.slice(-1);
        renderContent();
      }
    });

  searchInput.addEventListener("input", () => {
    filterAndRender();
  });

  // --- Inicijalizacija -----------------------------------------

  updateModeInfo();
  loadEntriesFromAPI();
</script>
</body>
</html>
